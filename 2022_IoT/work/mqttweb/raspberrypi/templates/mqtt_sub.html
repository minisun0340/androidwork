<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src = "https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js"
            type = "text/javascript"> </script>
    <script type="text/javascript">
        var host = "172.30.1.59";
        var port = 9001;
        var mqtt;
        //callback함수 - 접속이 완료된 후 호출되는 함수
        //1. broker서버와 접속이 완료되면 broker에 구독신청한다.
        //2. 메시지가 전송되면 호출될 콜백 함수를 정의
        //3. 콜백함수를 등록한다.
        function onConnect(){
            console.log("접속완료")
            mqtt.subscribe("iot/servo"); // 1번
        }
        //callback함수 - 접속이 실패하면 호출되는 함수
        function onFailure(){
            console.log("접속실패")
        }
        //2번
        //메시지가 전송되면 호출될 콜백함수 정의
        function onMessageArrived(msg){ //매개변수 msg는 꼭 정의해야 한다.
                                        //broker에서 메시지를 전송하면 onMessageArrived를 호출하면서
                                        //이 함수의 매개변수로 메시지를 전달
                                        //msg는 Message객체가 전달됨
            console.log("msg:"+ msg.payloadString);

            //mqtt로 전송된 메시지를 웹페이지에 적용
            //ex) 메시지를 차트에 적용, 이 메시지를 가공해서 다른 작업 활용, 메시지를 동영상으로 페이지 추가
            //웹페이지에 출력할 데이터
            out_msg = "메시지 전달:"+msg.payloadString
            //data로 정의된 <div>를 찾아오기
            content = document.getElementById("data") //id가 data로 정의된 element를 찾아오기
            content.innerHTML = out_msg

        }

        //publish하는 함수 정의
        function sendMsg(msg){
            //alert(msg)
            /*
            1. message객체 생성하기
            2. 토픽을 설정
            3. send 메소드를 호출
            */
            message = new Paho.MQTT.Message(msg);
            message.destinationName = "iot/led" //토픽설정
            mqtt.send(message); //mqtt메시지 보내기 - publish
        }
        //mqtt통신을 관리하기 위한 사용자정의 함수
        function MQTTConnect(){
            console.log("mqtt접속"+host+", "+port)
            //mqtt통신을 위한 클라이언트 객체 생성
            mqtt = new Paho.MQTT.Client(host, port, "javascript_client") //"javascript_client"는 클라이언트 ID
            //mqtt통신을 위해 필요한 설정을 명시
            var options = {
                timeout : 3,
                onSuccess:onConnect, //접속 성공했을 때 실행될 콜백함수 등록
                onFailure:onFailure,
            }
            //3번 메시지가 도착하면 실행될 콜백함수 등록
            mqtt.onMessageArrived = onMessageArrived;
            mqtt.connect(options);
        }
    </script>
</head>
<body>
    <script type="text/javascript">
        //사용자정의 함수를 호출해서 mqtt가 동작할 수 있도록 해준다.
        MQTTConnect()
    </script>
    <h1>MQTT와 웹소켓 테스트(sub)</h1>
    <div id="data"></div>
    <form>
        <input type = "button" value="led켜기" onclick="sendMsg('led_on')">
        <input type = "button" value="led끄기" onclick="sendMsg('led_off')">
    </form>
</body>
</html>