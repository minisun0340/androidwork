<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>pir_mqtt</title>
    <script src = "https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js"
            type = "text/javascript"> </script>
    <script type="text/javascript">
        var host = "172.30.1.33";
        var port = 9001;
        var mqtt;
    function onConnect(){
        console.log("접속 완료")
        mqtt.subscribe("pir");
    }
    function onFailure(){
        console.log("접속 실패")
    }
    function onMsgArr(msg){
        console.log("msg: "+msg.payloadString);
        out_msg = msg.payloadString
        if(out_msg == "motion detected"){
            alert("수상한 움직임이 있습니다.")
        }
    }
    //mqtt통신을 위한 함수
    function MQTTConnect(){
        console.log("mqtt접속"+host+", "+port)
        mqtt = new Paho.MQTT.Client(host, port, "javascript_client")
        var options = {
            timeout : 3,
            onSuccess:onConnect,
            onFailure:onFailure,
        }
        mqtt.onMessageArrived = onMsgArr;
        mqtt.connect(options);
    }
    function sendMsg(msg){
            //alert(msg)
            /*
            1. message객체 생성하기
            2. 토픽을 설정
            3. send 메소드를 호출
            */
            message = new Paho.MQTT.Message(msg);
            message.destinationName = "iot/led" //토픽설정
            mqtt.send(message); //mqtt메시지 보내기 - publish
        }

    </script>
</head>

<body>
    <h1>mqtt pir</h1>
    <script type="text/javascript">
        MQTTConnect()
    </script>
    <form>
        <input type = "checkbox" value="led_on" onclick="
               if (this.value === 'led_on'){
                    sendMsg('led_on');
                    this.value = 'led_off';
                }
                else{
                    sendMsg('led_off');
                    this.value = 'led_on';
                }">
    </form>
</body>
</html>